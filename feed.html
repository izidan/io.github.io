<html>

<head>
    <meta charset="utf-8" />
    <meta name="robots" content="none" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-control" content="max-age=604800, public">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="icon" href="https://uk.advfn.com/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="https://uk.advfn.com/favicon.ico" type="image/x-icon" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <!--script src="https://www.marketscreener.com/mods_a/charts/TV/charting_library/charting_library.min.js"></script>
    <script src="https://www.marketscreener.com/mods_a/charts/TV/charting_library/datafeed/udf/datafeed.js"></script-->
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script src="streamer-obfuscated.js"></script>
    <script src="string.js"></script>
    <script>
        if (typeof jQuery === "undefined" || jQuery === null)
            location.reload(true);

        const params = new URLSearchParams(location.search);
        const symbols = params.get('q').split(',');
        const username = params.get('u') || ''.random();
        const password = username.random();
        const websocket = new WebSocket("wss://connect.websocket.in/advfn_com?room_id=" + username);
        const widget = new TradingView.widget({
            "container_id": "tradingview", "height": 300, "width": "100%", "locale": "uk",
            "hide_top_toolbar": true, "enable_publishing": false, "symbol": 'LSE:' + symbols[0],
            disabled_features: ["link_to_tradingview", "use_localstorage_for_settings", "header_screenshot", "header_symbol_search", "header_saveload", "telemetry"],
            interval: "60", timezone: "exchange", theme: "Light", style: "1", "save_image": false, enabled_features: [],
            //client_id: '4-traders.com', user_id: 'public_user_id',
            //library_path: "https://www.marketscreener.com/mods_a/charts/TV/charting_library/",
            //charts_storage_url: 'https://cors-anywhere.herokuapp.com/www1.zonebourse.com/mods_a/charts/TV/function',
            //datafeed: new Datafeeds.UDFCompatibleDatafeed("https://cors-anywhere.herokuapp.com/www1.zonebourse.com/mods_a/charts/TV/function", 60000)
        });

        websocket.onmessage = msg => reset(msg.data);
        websocket.onerror = console.error;

        IPC.prototype._handleReconnection = reset;

        function send(msg) {
            if (websocket.readyState === 1)
                websocket.send(msg);
            else
                setTimeout(send, 1000, msg);
        }

        function reset(sessionId) {
            if (sessionId === username && !!localStorage[username])
                return send(localStorage[username]);
            else if (!!sessionId)
                localStorage[username] = sessionId;
            else {
                delete localStorage[username];
                return send(username);
            }
            if ([0, 6].includes(new Date().getDay()))
                console.log('market is currently closed in weekend.') ||
                    setTimeout(location.reload, (60 - new Date().getMinutes() + 60 * 23) * 60000);
            else if ((new Date().getHours() < 8 || new Date().getHours() > 16))
                console.log('market is currently closed.') ||
                    setTimeout(location.reload, (60 - new Date().getMinutes()) * 60000);
            else //if (new Date().getHours() >= 8 && new Date().getHours() <= 16) {
                setTimeout(onload, 3000);
            //onload();
        };

        function onload() {
            if (!!username && !!localStorage[username])
                app(username, localStorage[username], symbols);
            else
                login(username, password)
                    .then(json => app(json.screenName, json.sessionId, symbols))
                    .then(() => send(Env.getSession()._sid))
                    .catch(console.error);
        };

        function login(userName, password) {
            return fetch('https://cors-anywhere.herokuapp.com/secure.advfn.com:443/mobileAPI/MobileLogin', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
                    userName, password, appId: "com.advfn.android.mobile", appVersion: "2.0.5120", locale: "en-GB",
                    deviceToken: "N/A", deviceTokenType: "GCM\/legacy", deviceType: "Android\/8.0.0\/SM-G950F"
                })
            }).then(res => res.json()).then(json => json.account);
        };

        function app(screenName, sessionId, symbols) {
            console.log(widget.options);
            widget.options.symbol = 'LSE:' + symbols[0];
            widget.reload();
            let session = Env.getSession();
            let config = {
                site: 'uk',
                locale: 'en_GB',
                monitorId: null,
                appName: 'trades',
                timezone: 'GB-Eire',
                indices: ["FTSE:UKX"],
                timezoneOffset: new Date().getTimezoneOffset() * -60,
                rpcUrl: '//rpc.advfn.com',
                feedSymbol: 'L^' + symbols[0],
                displaySymbol: 'LSE:' + symbols[0],
                advfnUrl: '//uk.advfn.com',
                streamerUrl: 'wss://streamws.advfn.com',
                alternativeStreamerUrl: 'ws://streamws.advfn.com:7000',
                alternativeStreamerUrlFallback: 'ws://streamws.advfn.com:80',
                colorSchema: { up: '#000090', down: '#CF0000', unchanged: '#008000' },
                changeArrows: { up: 'blue_up.png', no_change: 'green_dot.png', down: 'red_down.png' },
                monitorSettings: { indexBreakUp: true, orderSymbols: true, defaultDisplay: "1", symbols: [] },
            };
            if (session) {
                if (session._bootConfiguration.feedSymbol === 'L^' + symbols[0]) return;
                else if (session._currentApp != null) {
                    session._currentApp.clearState();
                    session._currentApp._createTradesTable();
                }
                session._bootConfiguration.feedSymbol = 'L^' + symbols[0];
                session._bootConfiguration.displaySymbol = 'LSE:' + symbols[0];
                session = new Session(session._username, session._sid, session._bootConfiguration);
            } else session = new Session(screenName, localStorage[username] = sessionId, config);
            Env.setSession(session);
            session.start();
        }

        setInterval(function () {
            //$('#jsToolRoot,#wm').css('min-height', 0);
            //$('#jsToolRoot,#wm').css('height', $('#trades_app').css('height'));
            if (Env.getSymbol() && !!Env.getSymbol().getSymbol())
                document.title = Env.getSymbol().getSymbol() + ' ' + $("tr").first().text().split(/\n/)[3];
        }, 1000);

    </script>
</head>

<body style='margin: 0px; font-family: "Trebuchet MS", Helvetica, sans-serif' scroll='no' onload="onload()">
    <div id="jsToolRoot"></div>
    <div id="tradingview"></div>
</body>

</html>