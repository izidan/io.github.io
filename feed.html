<html>

<head>
    <meta charset="utf-8" />
    <meta name="robots" content="none" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-control" content="max-age=604800, public">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="icon" href="https://uk.advfn.com/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="https://uk.advfn.com/favicon.ico" type="image/x-icon" />
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="streamer.min.js"></script>
    <script>
        if (typeof jQuery === "undefined" || jQuery === null)
            location.reload(true);
        const params = new URLSearchParams(location.search);
        const symbols = params.get('q').split(',');
        const username = params.get('u') || 'thro1940';
        const password = username.replace(/i/gi, '1').replace(/o/gi, '0').replace(/^\w/, t => t.toUpperCase());
        const websocket = new WebSocket("wss://connect.websocket.in/advfn_com?room_id=" + username);

        websocket.onmessage = msg => reset(msg.data);
        websocket.onerror = console.error;

        IPC.prototype._handleReconnection = reset;

        function send(msg) {
            if (websocket.readyState === 1)
                websocket.send(msg);
            else
                setTimeout(send, 1000, msg);
        }

        function reset(sessionId) {
            if (sessionId === username && !!localStorage[username])
                return send(localStorage[username]);
            else if (!!sessionId)
                localStorage[username] = sessionId;
            else {
                delete localStorage[username];
                return send(username);
            }
            onload();
        };

        function onload() {
            if (!!username && !!localStorage[username])
                app(username, localStorage[username], symbols);
            else
                login(username, password)
                    .then(json => app(json.screenName, json.sessionId, symbols))
                    .then(() => send(Env.getSession()._sid))
                    .then(resort)
                    .catch(alert);
        };

        function login(userName, password) {
            return fetch('https://cors-anywhere.herokuapp.com/secure.advfn.com:443/mobileAPI/MobileLogin', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
                    userName, password, appId: "com.advfn.android.mobile", appVersion: "2.0.5120", locale: "en-GB",
                    deviceToken: "N/A", deviceTokenType: "GCM\/legacy", deviceType: "Android\/8.0.0\/SM-G950F"
                })
            }).then(res => res.json()).then(json => json.account);
        };

        function app(screenName, sessionId, symbols) {
            let session = new Session(screenName, localStorage[username] = sessionId, {
                site: 'uk',
                locale: 'en_GB',
                monitorId: null,
                appName: 'trades',
                timezone: 'GB-Eire',
                indices: ["FTSE:UKX"],
                timezoneOffset: new Date().getTimezoneOffset() * -60,
                rpcUrl: '//rpc.advfn.com',
                feedSymbol: 'L^' + symbols[0],
                displaySymbol: 'LSE:' + symbols[0],
                advfnUrl: '//uk.advfn.com',
                streamerUrl: 'wss://streamws.advfn.com',
                alternativeStreamerUrl: 'ws://streamws.advfn.com:7000',
                alternativeStreamerUrlFallback: 'ws://streamws.advfn.com:80',
                colorSchema: { up: '#000090', down: '#CF0000', unchanged: '#008000' },
                changeArrows: { up: 'blue_up.png', no_change: 'green_dot.png', down: 'red_down.png' },
                monitorSettings: { indexBreakUp: true, orderSymbols: true, defaultDisplay: "1", symbols: symbols },
            });
            Env.setSession(session);
            session.start();
        }

        setInterval(function () {
            $('#jsToolRoot,#wm').css('height', $('#trades_app').css('height'));
            $('#jsToolRoot,#wm').css('min-height', $('#trades_app').css('height'));
            document.title = Env.getSymbol().getSymbol() + ' ' + $("tr").first().text().split(/\n/)[3].trim();
        }, 1000);

    </script>
</head>

<body id="jsToolRoot" style='margin: 0px; font-family: "Trebuchet MS", Helvetica, sans-serif' scroll='no'
    onload="onload()"></body>

</html>